---

- name: ensure PHP packages are installed.
  package:
    name: "{{ item }}"
    state: "{{ php_packages_state }}"
  loop:
    "{{ php_packages }}"

- block:
    - name: create links for PHP packages
      file:
        src: "{{ item.src }}"
        dest: "{{ item.dest }}"
        state: link
      loop:
        - { src: "/opt/remi/php{{ php_package_version }}/root/usr/bin/php", dest: /usr/bin/php }
        - { src: "/opt/remi/php{{ php_package_version }}/root/usr/bin/php-cgi", dest: /usr/bin/php-cgi }
        - { src: "/opt/remi/php{{ php_package_version }}/root/usr/bin/pecl", dest: /usr/bin/pecl }
        - { src: "/opt/remi/php{{ php_package_version }}/root/usr/bin/pear", dest: /usr/bin/pear }
        - { src: "/opt/remi/php{{ php_package_version }}/root/usr/bin/phar", dest: /usr/bin/phar }
        - { src: "/opt/remi/php{{ php_package_version }}/root/usr/sbin/php-fpm", dest: /usr/sbin/php-fpm }
        - { src: "/etc/opt/remi/php{{ php_package_version }}/php.d", dest: /etc/php.d }
        - { src: "/etc/opt/remi/php{{ php_package_version }}/php-fpm.d", dest: /etc/php-fpm.d }
        - { src: "/usr/lib/systemd/system/php{{ php_package_version }}-php-fpm.service", dest: /usr/lib/systemd/system/php-fpm.service }

    - name: create overwrite.conf for systemd
      template:
        src: systemd/overwrite.conf.j2
        dest: "/etc/systemd/system/php{{ php_package_version }}-php-fpm.service.d/override.conf"
      notify:
        - systemctl daemon-reload
        - restart php-fpm

  when: ansible_os_family | lower == 'redhat'


- name: detect installed php version
  shell: "php -v 2> /dev/null | grep NTS | awk -F 'PHP ' '{printf $2}' | cut -d . -f 1-2"
  register: __installed_php_version

- name: define php version.
  set_fact:
    php_version: "{{ __installed_php_version.stdout }}"
  when: __installed_php_version is defined and __installed_php_version.rc is defined and __installed_php_version.rc == 0

- name: re-read OS-specific variables.
  include_vars: main.yml
