---

- block:
    # bionic provides PHP 7.2
    # buster provides PHP 7.3
    # stretch provides PHP 7.0
    - name: update the local repositories
      apt:
        update_cache: true

    - name: detect available php version
      shell: |
        apt-cache show php | grep Version | sort | tail -n1 | awk -F'[:+]' '{print $3}' | tr -d '[:space:]'
      args:
        warn: false
      no_log: true
      register: _detected_php_version

    - name: define PHP Version
      set_fact:
        php_version: "{{ _detected_php_version.stdout }}"

  when: ansible_os_family | lower == "debian"

- block:
    # centos7 provides PHP 5.4(.16) m(
    # we use remi packages for newer version
    # https://blog.remirepo.net/post/2018/12/10/Install-PHP-7.3-on-CentOS-RHEL-or-Fedora
    - name: detect available php version
      shell: |
        yum info php73 | grep Summary | cut -d ':' -f 2 | tr -d '[:space:]' | cut -c23-25
      args:
        warn: false
      no_log: true
      register: _detected_php_version

    - name: define PHP Version
      set_fact:
        php_version: "{{ _detected_php_version.stdout }}"

  when: ansible_os_family | lower == "redhat"

- name: set php_version to '{{ php_version }}'
  set_fact:
    php_version: "{{ php_version }}"

- name: set php_package_version
  set_fact:
    php_package_version: "{{ php_version | replace('.','') }}"

- name: do facts module to get latest information
  setup:

- name: include OS-specific variables.
  include_vars: main.yml
